import React, { useState, useEffect, useRef } from "react";
import { DragDropContext, Droppable, Draggable } from "@hello-pangea/dnd";

interface Topic {
  id: string;
  name: string;
  time: number;
  color: string;
}

export default function App() {
  const [meetingName, setMeetingName] = useState("Meeting Agenda Planner");
  const [duration, setDuration] = useState(60);
  const [topics, setTopics] = useState<Topic[]>([
    { id: "1", name: "Introductions", time: 10, color: "#4F46E5" },
    { id: "2", name: "Project Updates", time: 20, color: "#10B981" },
    { id: "3", name: "Discussion", time: 20, color: "#F59E0B" },
    { id: "4", name: "Wrap-up", time: 10, color: "#EF4444" },
  ]);

  const [isPlaying, setIsPlaying] = useState(false);
  const [elapsedMinutes, setElapsedMinutes] = useState(0);
  const timerRef = useRef<NodeJS.Timeout | null>(null);

  const totalAllocated = topics.reduce((a, t) => a + t.time, 0);
  const remaining = duration - totalAllocated;

  // ---- Meeting Timer Logic (Real Time: 1 minute = 1 minute) ----
  useEffect(() => {
    if (isPlaying) {
      timerRef.current = setInterval(() => {
        setElapsedMinutes((prev) => {
          if (prev >= duration) {
            clearInterval(timerRef.current!);
            setIsPlaying(false);
            return duration;
          }
          return prev + 1;
        });
      }, 60_000); // ‚è±Ô∏è 1 real minute = 1 agenda minute
    }
    return () => clearInterval(timerRef.current!);
  }, [isPlaying]);

  const handlePlayPause = () => setIsPlaying((p) => !p);
  const handleRestart = () => {
    setElapsedMinutes(0);
    setIsPlaying(false);
  };

  // ---- Drag and Drop ----
  const handleDragEnd = (result: any) => {
    if (!result.destination) return;
    const reordered = Array.from(topics);
    const [moved] = reordered.splice(result.source.index, 1);
    reordered.splice(result.destination.index, 0, moved);
    setTopics(reordered);
  };

  // ---- Topic Controls ----
  const handleRenameTopic = (id: string, newName: string) => {
    setTopics((prev) =>
      prev.map((t) => (t.id === id ? { ...t, name: newName } : t))
    );
  };
  const handleTimeChange = (id: string, val: string) => {
    setTopics((prev) =>
      prev.map((t) => (t.id === id ? { ...t, time: Number(val) } : t))
    );
  };
  const handleColorChange = (id: string, newColor: string) => {
    setTopics((prev) =>
      prev.map((t) => (t.id === id ? { ...t, color: newColor } : t))
    );
  };
  const handleAdd = () => {
    const newId = Date.now().toString();
    const colors = ["#4F46E5", "#10B981", "#F59E0B", "#EF4444", "#3B82F6"];
    setTopics([
      ...topics,
      {
        id: newId,
        name: "New Section",
        time: 10,
        color: colors[Math.floor(Math.random() * colors.length)],
      },
    ]);
  };
  const handleDelete = (id: string) => {
    setTopics((prev) => prev.filter((t) => t.id !== id));
  };

  const linePosition = (elapsedMinutes / duration) * 100;

  return (
    <div
      style={{
        height: "100vh",
        width: "100vw",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        background: "black",
      }}
    >
      <div
        style={{
          padding: "2rem",
          fontFamily: "sans-serif",
          maxWidth: 600,
          width: "90%",
          background: "#121212",
          borderRadius: "12px",
          boxShadow: "0 4px 20px rgba(255,255,255,0.1)",
          color: "white",
        }}
      >
        {/* Editable Meeting Name */}
        <input
          type="text"
          value={meetingName}
          onChange={(e) => setMeetingName(e.target.value)}
          style={{
            width: "100%",
            background: "transparent",
            border: "none",
            color: "white",
            fontSize: "1.5rem",
            fontWeight: "bold",
            textAlign: "center",
            marginBottom: "1rem",
          }}
        />

        {/* Meeting Duration & Controls */}
        <div style={{ marginBottom: 10, textAlign: "center" }}>
          <label>Duration (minutes): </label>
          <input
            type="number"
            value={duration}
            onChange={(e) => setDuration(Number(e.target.value))}
            style={{
              width: 60,
              marginLeft: 10,
              background: "#1e1e1e",
              border: "1px solid #333",
              color: "white",
              borderRadius: 4,
              padding: "2px 4px",
            }}
          />
          <p style={{ color: remaining < 0 ? "red" : "#aaa" }}>
            Remaining time: {remaining} min
          </p>
        </div>

        {/* Timer Controls */}
        <div
          style={{
            display: "flex",
            justifyContent: "center",
            gap: "10px",
            marginBottom: "1rem",
          }}
        >
          <button
            onClick={handlePlayPause}
            style={{
              background: isPlaying ? "#F59E0B" : "#10B981",
              color: "white",
              border: "none",
              borderRadius: "6px",
              padding: "8px 14px",
              cursor: "pointer",
              fontWeight: "bold",
            }}
          >
            {isPlaying ? "Pause ‚è∏Ô∏è" : "Play ‚ñ∂Ô∏è"}
          </button>
          <button
            onClick={handleRestart}
            style={{
              background: "#3B82F6",
              color: "white",
              border: "none",
              borderRadius: "6px",
              padding: "8px 14px",
              cursor: "pointer",
              fontWeight: "bold",
            }}
          >
            Restart üîÅ
          </button>
        </div>

        {/* Add Section Button */}
        <button
          onClick={handleAdd}
          style={{
            background: "#3B82F6",
            color: "white",
            border: "none",
            padding: "8px 14px",
            borderRadius: "6px",
            marginBottom: "10px",
            cursor: "pointer",
            width: "100%",
            fontWeight: "bold",
          }}
        >
          + Add Section
        </button>

        {/* Timeline Container */}
        <div
          style={{
            position: "relative",
            height: 400,
            border: "1px solid #333",
            borderRadius: 8,
            overflow: "hidden",
            marginTop: 10,
            display: "flex",
            flexDirection: "column",
            background: "#1c1c1c",
          }}
        >
          {/* Moving line */}
          <div
            style={{
              position: "absolute",
              top: `${linePosition}%`,
              left: 0,
              width: "100%",
              height: "2px",
              background: "red",
              zIndex: 2,
              transition: "top 60s linear", // smooth movement per minute
            }}
          ></div>

          <DragDropContext onDragEnd={handleDragEnd}>
            <Droppable droppableId="agenda">
              {(provided) => (
                <div
                  ref={provided.innerRef}
                  {...provided.droppableProps}
                  style={{
                    flexGrow: 1,
                    display: "flex",
                    flexDirection: "column",
                  }}
                >
                  {topics.map((topic, index) => (
                    <Draggable
                      key={topic.id}
                      draggableId={topic.id}
                      index={index}
                    >
                      {(provided) => (
                        <div
                          ref={provided.innerRef}
                          {...provided.draggableProps}
                          {...provided.dragHandleProps}
                          style={{
                            height: `${(topic.time / duration) * 100}%`,
                            background: topic.color,
                            color: "white",
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "space-between",
                            padding: "0 10px",
                            borderBottom: "1px solid rgba(255,255,255,0.3)",
                            position: "relative",
                            zIndex: 1,
                            ...provided.draggableProps.style,
                          }}
                        >
                          <input
                            type="text"
                            value={topic.name}
                            onChange={(e) =>
                              handleRenameTopic(topic.id, e.target.value)
                            }
                            style={{
                              background: "transparent",
                              border: "none",
                              color: "white",
                              fontWeight: "bold",
                              width: "45%",
                            }}
                          />

                          <div style={{ display: "flex", alignItems: "center" }}>
                            <input
                              type="color"
                              value={topic.color}
                              onChange={(e) =>
                                handleColorChange(topic.id, e.target.value)
                              }
                              style={{
                                marginRight: 8,
                                border: "none",
                                width: 25,
                                height: 25,
                                cursor: "pointer",
                                background: "transparent",
                              }}
                            />
                            <input
                              type="range"
                              min="5"
                              max={duration}
                              value={topic.time}
                              step="5"
                              onChange={(e) =>
                                handleTimeChange(topic.id, e.target.value)
                              }
                            />
                            <span style={{ marginLeft: 8 }}>
                              {topic.time}m
                            </span>
                            <button
                              onClick={() => handleDelete(topic.id)}
                              style={{
                                marginLeft: 10,
                                background: "rgba(255,255,255,0.3)",
                                border: "none",
                                color: "white",
                                cursor: "pointer",
                                borderRadius: "4px",
                                padding: "2px 6px",
                              }}
                            >
                              ‚úï
                            </button>
                          </div>
                        </div>
                      )}
                    </Draggable>
                  ))}
                  {provided.placeholder}
                </div>
              )}
            </Droppable>
          </DragDropContext>
        </div>
      </div>
    </div>
  );
}
